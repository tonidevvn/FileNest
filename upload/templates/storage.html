{% extends "basewnav.html" %}

{% block title %}Object Storage{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-max">
        <h2 class="text-2xl font-bold mb-6 text-center">Object Storage</h2>
        <hr class="mb-4">
        {% csrf_token %}
        {% if uploads.count > 0 %}
        <h2 class="text-xl font-semibold mt-6">Your Uploaded Files</h2>
        <table class="table-auto w-full mt-4 border-collapse border border-gray-300">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-gray-300 px-4 py-2">No</th>
                    <th class="border border-gray-300 px-4 py-2">File Name</th>
                    <th class="border border-gray-300 px-4 py-2">File Size</th>
                    <th class="border border-gray-300 px-4 py-2">Uploaded By</th>
                    <th class="border border-gray-300 px-4 py-2">Uploaded At</th>
                    <th class="border border-gray-300 px-4 py-2">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for upload in uploads %}
                <tr id="file-row-{{ upload.file_key }}" class="bg-white">
                    <td class="border border-gray-300 px-4 py-2">{{ forloop.counter }}</td>
                    <td class="border border-gray-300 px-4 py-2"><a href="{{ upload.file.url }}" class="text-blue-500 underline">{{ upload.file.name }}</a></td>
                    <td class="border border-gray-300 px-4 py-2">{{ upload.file_size }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ upload.uploaded_by.username }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ upload.uploaded_at }}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="downloadFile('{{ upload.file.url }}', '{{ upload.file.name }}')" class="cursor-pointer w-12 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                            <i class="fa fa-cloud-download" aria-hidden="true"></i>
                        </button>
                        <button onclick="deleteFile('{{ upload.file_key }}', 'file-row-{{ upload.file_key }}')" class="cursor-pointer w-12 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-700">
                            <i class="fa fa-trash-o" aria-hidden="true"></i>
                        </button>

                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="border border-gray-300 px-4 py-2 text-center">No files available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <script>
            function deleteFile(fileKey, rowId) {
                if (confirm("Are you sure you want to delete this file?")) {
                    fetch(`/api/delete/${fileKey}/`, {
                        method: "DELETE",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            Toastify({
                                text: "File deleted successfully!",
                                className: "info",
                                duration: 3000,
                                gravity: "bottom", // `top` or `bottom`
                            }).showToast();

                            // Wait for 500ms before refreshing the page
                            setTimeout(() => document.getElementById(rowId).remove(), 500);
                        } else {
                            alert("Error: " + data.error);
                        }
                    })
                    .catch(error => console.error("Error deleting file:", error));
                }
            }

            function downloadFile(fileUrl, fileName) {
                fetch(fileUrl,
                    {
                        headers: new Headers(
                            {
                            Origin: location.origin,
                            }),
                        mode: "cors",
                    })
                    .then(response => response.blob())
                    .then(blob => {

                    const blobUrl  = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = blobUrl ;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch((e) => console.error(e));
            }
        </script>
        {% else %}
            <p>There is no upload files in this storage.</p>
        {% endif %}

    </div>
</div>
{% endblock %}
