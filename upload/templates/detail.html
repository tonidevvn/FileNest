{% extends "base.html" %}

{% block title %}File Chunks - {{ file_metadata.file_name }}{% endblock %}

{% block content %}
<div class="mt-4 md:mt-8 flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-max min-w-3/4 min-h-115">
        <h2 class="text-2xl font-bold mb-6 text-center">ðŸ“Ž Object Info</h2>
        <hr class="mb-4">

        <p class="font-semibold">Name: {{ file_metadata.file_name }}</p>
        <p class="font-semibold ">Storage Location:
            <span class="text-gray-600">
                <i class="fa fa-hdd-o" aria-hidden="true"></i> <strong>Minio</strong>
            </span>
        </p>
        <p class="font-semibold">Size:
            <span class="text-gray-600">{{ file_metadata.file_size |filesizeformat }}</span>
        </p>
        <p class="font-semibold">Uploaded By:
            <span class="text-gray-600">{{ file_metadata.uploaded_by }}</span>
        </p>
        <p class="font-semibold">Last Modified:
            <span class="text-gray-600">{{ file_metadata.uploaded_at }}</span>
        </p>

        {% if is_image %}
            <p class="font-semibold">File Preview:</p>
            <div class="flex">
                <a href="{{ file_metadata.file_url  }}" target="_blank" class="max-w-4/5 rounded-xl bg-gray-950/5 opacity-85 overflow-hidden p-sm">
                    <img src="{{ file_metadata.file_url }}" alt="" class="w-full rounded-xl p-1" />
                </a>
            </div>
        {% endif %}

        {% if chunks %}
        <p class="text-gray-600">Total Chunks: {{ file_metadata.total_chunks }}</p>

        <table class="table-auto w-full mt-4 border-collapse border border-gray-300">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-gray-300 px-4 py-2">Chunk No</th>
                    <th class="border border-gray-300 px-4 py-2">Chunk Name</th>
                    <th class="border border-gray-300 px-4 py-2">Size</th>
                    <th class="border border-gray-300 px-4 py-2">Uploaded At</th>
                </tr>
            </thead>
            <tbody>
                {% for chunk in chunks %}
                <tr>
                    <td class="border border-gray-300 px-4 py-2">{{ chunk.chunk_index }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ chunk.chunk_file.name }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ chunk.chunk_file.size|filesizeformat }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ chunk.uploaded_at }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="border border-gray-300 px-4 py-2 text-center">No chunks found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
        <div class="flex gap-4 mt-4">
            <button onclick="downloadFile('{{ file_metadata.file_url }}', '{{ file_metadata.file_name }}')" class="cursor-pointer bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Download</button>
            <button onclick="deleteFile('{{ file_metadata.id }}')" class="cursor-pointer bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
        </div>

        <div class="text-center mt-6">
            <a href="{% url 'storage' %}" class="text-blue-500 underline">Back to Storage</a>
        </div>
    </div>
</div>
    <script>
            function deleteFile(id) {
                if (confirm("Are you sure you want to delete this file?")) {
                    fetch(`/api/delete/${id}/`, {
                        method: "DELETE",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            Toastify({
                                text: "File deleted successfully!",
                                className: "info",
                                duration: 3000,
                                gravity: "bottom", // `top` or `bottom`
                            }).showToast();

                            // Wait for 500ms before redirect to the storage page
                            setTimeout(() => window.location.href = "{% url 'storage' %}", 500);
                        } else {
                            alert("Error: " + data.error);
                        }
                    })
                    .catch(error => console.error("Error deleting file:", error));
                }
            }

            function downloadFile(fileUrl, fileName) {
                fetch(fileUrl,
                    {
                        headers: new Headers(
                            {
                            Origin: location.origin,
                            }),
                        mode: "cors",
                    })
                    .then(response => response.blob())
                    .then(blob => {

                    const blobUrl  = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = blobUrl ;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch((e) => console.error(e));
            }
        </script>
{% endblock %}
