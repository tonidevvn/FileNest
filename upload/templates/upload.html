{% extends "basewnav.html" %}

{% block title %}Upload{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-max">
        <h2 class="text-2xl font-bold mb-6 text-center">Upload Your File</h2>
        <hr class="mb-4">
        <form action="{% url 'upload' %}" method="post" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <div class="field">
                <div class="control">
                    <label class="block text-gray-700 font-semibold">Choose a file:</label>
                    <input class="file-input w-full p-2 border border-gray-300 rounded" type="file" name="image_file">
                </div>
            </div>
            <div class="field">
                <div class="control text-center">
                    <input type="submit" value="Submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-700 cursor-pointer">
                </div>
            </div>
        </form>
        {% if image_url %}
        <p id="file_uploaded_msg" class="text-center text-green-500 mt-4" onload="uploadedFile()">File uploaded at: <a href="{{ image_url }}" class="text-blue-500 underline" >{{ image_url }}</a></p>
        <script>
            document.addEventListener("DOMContentLoaded", (event) => {
                console.log("hello")
                Toastify({
                    text: "File uploaded successfully!",
                    className: "info",
                    duration: 3000,
                    gravity: "bottom", // `top` or `bottom`
                }).showToast();
            });
        </script>
        {% endif %}

        {% if uploads.count > 0 %}
        <h2 class="text-xl font-semibold mt-6">Your Uploaded Files</h2>
        <table class="table-auto w-full mt-4 border-collapse border border-gray-300">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-gray-300 px-4 py-2">No</th>
                    <th class="border border-gray-300 px-4 py-2">File Name</th>
                    <th class="border border-gray-300 px-4 py-2">File Size</th>
                    <th class="border border-gray-300 px-4 py-2">Uploaded By</th>
                    <th class="border border-gray-300 px-4 py-2">Uploaded At</th>
                    <th class="border border-gray-300 px-4 py-2">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for upload in uploads %}
                <tr id="file-row-{{ upload.file_key }}" class="bg-white">
                    <td class="border border-gray-300 px-4 py-2">{{ forloop.counter }}</td>
                    <td class="border border-gray-300 px-4 py-2"><a href="{{ upload.file.url }}" class="text-blue-500 underline">{{ upload.file.name }}</a></td>
                    <td class="border border-gray-300 px-4 py-2">{{ upload.file_size }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ upload.uploaded_by.username }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ upload.uploaded_at }}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="deleteFile('{{ upload.file_key }}', 'file-row-{{ upload.file_key }}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="border border-gray-300 px-4 py-2 text-center">No files available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <script>
            function deleteFile(fileKey, rowId) {
                if (confirm("Are you sure you want to delete this file?")) {
                    fetch(`/delete/${fileKey}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            Toastify({
                                text: "File deleted successfully!",
                                className: "info",
                                duration: 3000,
                                gravity: "bottom", // `top` or `bottom`
                            }).showToast();

                            // Wait for 500ms before refreshing the page
                            setTimeout(() => document.getElementById(rowId).remove(), 500);
                        } else {
                            alert("Error: " + data.error);
                        }
                    })
                    .catch(error => console.error("Error deleting file:", error));
                }
            }
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}
