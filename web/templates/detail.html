{% extends "base.html" %}

{% block title %}Object Info{% endblock %}

{% block content %}
{% csrf_token %}
<div class="mt-4 md:mt-8 flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-3xl">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fa fa-file-o mr-2"></i> Object Info
            </h1>
            <a href="{% url 'web:storage' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
                <i class="fa fa-arrow-left mr-1"></i> Back to storage
            </a>
        </div>
        
        <hr class="my-4">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Basic Information</h3>
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Name:</span>
                        <span class="text-gray-600 break-all">{{ file_metadata.file_name }}</span>
                    </p>
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Size:</span>
                        <span class="text-gray-600">{{ file_metadata.file_size|filesizeformat }}</span>
                    </p>
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Storage:</span>
                        <span class="text-gray-600">
                            <i class="fa fa-hdd-o mr-1"></i> <strong>MinIO</strong>
                        </span>
                    </p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Upload Information</h3>
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Uploaded by:</span>
                        <span class="text-gray-600">{{ file_metadata.uploaded_by }}</span>
                    </p>
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Date:</span>
                        <span class="text-gray-600">{{ file_metadata.created_at }}</span>
                    </p>
                </div>
            </div>
            
            <div class="space-y-4">
                {% if request.user.is_staff %}
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">System Details</h3>
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Storage ID:</span>
                        <span class="text-gray-600 break-all">{{ file_metadata.storage_id }}</span>
                    </p>
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Chunks:</span>
                        <span class="text-gray-600">{{ file_metadata.total_chunks }}</span>
                    </p>
                    {% if file_metadata.metadata %}
                    <p class="flex items-baseline mb-2">
                        <span class="font-semibold text-gray-700 w-24">Metadata:</span>
                        <span class="text-gray-600 break-all">{{ file_metadata.metadata }}</span>
                    </p>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3">Actions</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="downloadFile('{{ file_metadata.id }}', '{{ file_metadata.file_name }}')" class="flex items-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition">
                            <i class="fa fa-download mr-2"></i> Download
                        </button>
                        
                        <button onclick="deleteFile('{{ file_metadata.id }}')" class="flex items-center bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition">
                            <i class="fa fa-trash mr-2"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function downloadFile(file_id, file_name) {
        fetch(`/api/files/${file_id}/download/`)
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Network response was not ok.');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = file_name;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                Toastify({
                    text: `File ${file_name} downloaded successfully!`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "#4CAF50",
                    }
                }).showToast();
            })
            .catch(error => {
                console.error('Download failed:', error);
                Toastify({
                    text: "Download failed",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "#F44336",
                    }
                }).showToast();
            });
    }
    
    function deleteFile(file_id) {
        // Display a confirmation dialog
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to recover this file!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // User confirmed, proceed with deletion
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                fetch(`/api/files/${file_id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                })
                .then(response => {
                    if (response.ok) {
                        Swal.fire(
                            'Deleted!',
                            'Your file has been deleted.',
                            'success'
                        ).then(() => {
                            window.location.href = "{% url 'web:storage' %}";
                        });
                    } else {
                        throw new Error('Failed to delete');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error!',
                        'Failed to delete the file.',
                        'error'
                    );
                });
            }
        });
    }
</script>
{% endblock %}
